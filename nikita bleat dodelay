from flask import Flask, request
import logging
import json
import random

app = Flask(__name__)

logging.basicConfig(level=logging.INFO)

get_sack = False
sessionStorage = {}


@app.route('/post', methods=['POST'])
def main():

    logging.info('Request: %r', request.json)

    response = {
        'session': request.json['session'],
        'version': request.json['version'],
        'response': {
            'end_session': False
        }
    }

    handle_dialog(response, request.json)

    logging.info('Request: %r', response)

    return json.dumps(response)


def handle_dialog(res, req):

    user_id = req['session']['user_id']

    if req['session']['new']:

        res['response']['text'] = 'Привет! Назови свое имя!'
        sessionStorage[user_id] = {
            'first_name': None,
            'game_started': False
        }

        return

    first_name = get_first_name(req)

    if sessionStorage[user_id]['first_name'] is None:

        if first_name is None:
            res['response']['text'] = 'Не раслышала имя. Повтори!'
        else:
            sessionStorage[user_id]['first_name'] = first_name
            res['response']['text'] = 'Приятно познакомиться, ' + first_name.title()
            res['response']['text'] = 'Сыграем?'
            res['response']['buttons'] = [
                {
                    'title': 'Да',
                    'hide': True

                },
                {
                    'title': 'Нет',
                    'hide': True

                },
                {
                    'title': 'Помощь',
                    'hide': True
                },
                {
                    'title': 'Действующие лица',
                    'hide': True
                    }
            ]

    else:

        if not sessionStorage[user_id]['game_started']:

            if 'да' in req['request']['nlu']['tokens']:

                if get_sack:

                    res['response']['text'] = 'вас уволилил'
                    res['end_session'] = True

                else:

                    sessionStorage[user_id]['game_started'] = True
                    play_game(res, req)



            elif 'нет' in req['request']['nlu']['tokens']:
                res['response']['text'] = 'Ну и ладно!'
                res['end_session'] = True
            elif req['request']['original_utterance'].lower() == 'действующие лица':
                characters(res)
                res['response']['buttons'] = [
                {
                    'title': 'Да',
                    'hide': True

                },
                {
                    'title': 'Нет',
                    'hide': True

                },
                {
                    'title': 'Помощь',
                    'hide': True
                },
                {
                    'title': 'Действующие лица',
                    'hide': True
                    }
            ]
            elif req['request']['original_utterance'].lower() == 'помощь':
                help(res)
                res['response']['buttons'] = [
                {
                    'title': 'Да',
                    'hide': True

                },
                {
                    'title': 'Нет',
                    'hide': True

                },
                {
                    'title': 'Помощь',
                    'hide': True
                },
                {
                    'title': 'Действующие лица',
                    'hide': True
                    }
            ]
            else:
                res['response']['text'] = 'Не понял ответа! Так да или нет?'
                res['response']['buttons'] = [
                {
                    'title': 'Да',
                    'hide': True

                },
                {
                    'title': 'Нет',
                    'hide': True

                },
                {
                    'title': 'Помощь',
                    'hide': True
                },
                {
                    'title': 'Действующие лица',
                    'hide': True
                    }
            ]
        elif req['request']['original_utterance'].lower() == 'помощь':
               help(res, req)
        
        else:
            play_game(res, req)


def characters(res, req):
    res['response']['text'] = '• Аннализ Киттинг – адвокат, преподаёт в Университете Миддлтон право,' \
                               'жена Сэма Киттинга, имеет свою частную фирму\n'\
                               '• Сэм Киттинг – психолог, муж Аннализ, преподаёт в Университете Миддлтон философию\n'\
                               '• Нэйт Лэхи – детектив, бывший любовник Аннализ\n'\
                               '• Уэс Гиббинс – студент Аннализ\n'\
                               '• Коннор Уолш – студент Аннализ\n'\
                               '• Микаэлла Пратт – студентка Аннализ\n'\
                               '• Ашер Миллстоун – студент Аннализ\n'\
                               '• Лорел Кастильо – студентка Аннализ\n'\
                               '• Фрэнк Дельфино – сотрудник фирмы Аннализ\n'\
                               '• Бонни Уинтерботтом – сотрудница фирмы Аннализ\n'\
                               '• Оливер Хэмптон – парень Коннора, IT-специалист\n'\
                               '• Лайла Стэнгард – бывшая любовница Сэма, его студентка'
    return
    
def play_game(res, req):
    res['response']['text'] = '''Вы – Нэйт Лэхи, офицер полиции. Обладаете незаурядным умом и можете раскрыть даже самое запутанное дело.
     							И ваша задача найти Лайлу Стенгард, пропавшую 30 августа 2014 года , где она застукала своего парня, Гриффина О’Райли и подругу Ребекку Саттер вместе.
     							Несколько дней спустя, её тело было найдено в резервуаре на крыше кампуса.
                                О’Райли и Саттер были арестованы на следующий после этого день.
								Известно, что Ребекка работала в баре за пределами кампуса, где студенты покупали наркотики. Она привлекалась за хранение и продажу.
								Что вы будете делать?'''
	res['response']['buttons'] = [
        {
            'title': 'Наведу справки о группе студентов Киттинг',
            'hide': True
            },
        {
            'title': 'Перечитаю материалы дела Стэнгард',
            'hide': True
            },
        {
            'title': 'Пойду в бар и напьюсь',
            'hide': True
            }
        ]
    if req['request']['original_utterance'].lower() == 'наведу справки о группе студентов киттинг':
    	res['response']['text'] = '''Вы порылись в базе данных и вот что там нашли: мать Уэса Гиббинса покончила с собой, когда ему было 12.
    								Про отца ничего не известно. 
									Родители Лорел Кастильо разведены. Отец может быть замешан в чём-то противозаконном.
									У Микаэллы Пратт отличное резюме и идеальная характеристика.
									Вы читали досье очередного студента, как вдруг у вас зазвонил телефон. 
									Возьмёте трубку или сбросите?'''
		res['response']['buttons'] = [
        {
            'title': 'Посмотреть на телефон',
            'hide': True
            },
        {
            'title': 'Проигнорировать',
            'hide': True}
        ]
	if req['request']['original_utterance'].lower() == 'посмотреть на телефон':
	    	res['response']['text'] = '''Звонит Аннализ Киттинг. она подозревает Сэма в причастности к убийству Лайлы и просит вас ей помочь, а именно: выяснить,
	    								где был её муж в ночь с 29 на 30 августа.
										На следующий же день поехали в Коннектикут. Сэм должен был читать лекцию по философии в Йельском университете, но он там не появился.
										Теперь уже и у вас начинают появляться подозрения по поводу причастности Сэма.'''
	elif req['request']['original_utterance'].lower() == 'проигнорировать':
			res['response']['text'] = '''вы проигнорировали звонок'''

    return

def help(res):
    res['response']['text'] = '''
    Данная игра представляет собой текстовый квест. Вам будет предложено сыграть за детектива Нэйла Лэхи, которому предстоит расследовать убийство.
     Вам будут предложены несколько вариантов ответа, благодоря которым вы будите продвигаться по сюжету и раскроете убийство. Приятной игры'''

def get_first_name(req):

    for entity in req['request']['nlu']['entities']:

        if entity['type'] == 'YANDEX.FIO':

            if 'first_name' in entity['value'].keys():
                return entity['value']['first_name']
            else:
                return None
    return None


if __name__ == '__main__':
    app.run()
